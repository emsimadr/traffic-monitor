{% extends "_layout.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <p class="muted">24h counts and a live feed with the current counting line.</p>

  <section class="card stats-bar">
    <div class="stat">
      <div class="label">Southbound (24h)</div>
      <div class="value" id="stat-south">--</div>
    </div>
    <div class="stat stat-main">
      <div class="label">Total (24h)</div>
      <div class="value big" id="stat-total">--</div>
    </div>
    <div class="stat">
      <div class="label">Northbound (24h)</div>
      <div class="value" id="stat-north">--</div>
    </div>
  </section>

  <section class="card live-shell">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div class="label">Live feed</div>
      <div class="muted" id="live-updated">â€”</div>
    </div>
    <div class="live-wrap">
      <img src="/api/camera/live.mjpg" id="live-img" alt="Live stream">
      <canvas id="live-overlay"></canvas>
    </div>
    <div class="muted" style="margin-top:8px;">Counting line pulled from calibration.</div>
    <div class="muted" id="dash-error"></div>
  </section>

  <script>
    const dirKeys = {
      north: ['northbound', 'north', 'N'],
      south: ['southbound', 'south', 'S'],
    };

    const liveImg = document.getElementById('live-img');
    const overlay = document.getElementById('live-overlay');
    const ctx = overlay.getContext('2d');
    let countingLine = null;

    function pickDir(map, keys) {
      for (const k of keys) {
        if (map[k] !== undefined) return map[k];
      }
      return 0;
    }

    function resizeCanvas() {
      const rect = liveImg.getBoundingClientRect();
      overlay.width = Math.max(1, Math.floor(rect.width));
      overlay.height = Math.max(1, Math.floor(rect.height));
      drawLine();
    }

    function drawLine() {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      if (!countingLine || countingLine.length !== 2) return;
      const [p1, p2] = countingLine;
      const toPx = (p) => ({
        x: p[0] * overlay.width,
        y: p[1] * overlay.height,
      });
      const a = toPx(p1);
      const b = toPx(p2);
      ctx.strokeStyle = 'rgba(0, 201, 255, 0.9)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(a.x, a.y);
      ctx.lineTo(b.x, b.y);
      ctx.stroke();
    }

    function setDefaultLine() {
      // horizontal midpoint fallback
      countingLine = [
        [0.0, 0.5],
        [1.0, 0.5],
      ];
      drawLine();
    }

    async function loadCalibrationLine() {
      try {
        const res = await fetch('/api/calibration');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const cl = data?.detection?.counting_line;
        countingLine = Array.isArray(cl) && cl.length === 2 ? cl : null;
        if (!countingLine) {
          setDefaultLine();
        } else {
          drawLine();
        }
      } catch (e) {
        document.getElementById('dash-error').textContent = 'Counting line unavailable';
        setDefaultLine();
      }
    }

    async function refreshStats() {
      const errEl = document.getElementById('dash-error');
      errEl.textContent = '';
      try {
        const res = await fetch('/api/stats/summary');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const dir = data.last_24h_by_direction || {};
        const south = pickDir(dir, dirKeys.south);
        const north = pickDir(dir, dirKeys.north);
        const total = Number.isFinite(data.last_24h) ? data.last_24h : (south + north);

        document.getElementById('stat-south').textContent = south ?? '--';
        document.getElementById('stat-north').textContent = north ?? '--';
        document.getElementById('stat-total').textContent = total ?? '--';
        document.getElementById('live-updated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        errEl.textContent = 'Stats unavailable';
      }
    }

    liveImg.addEventListener('load', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);
    if (liveImg.complete) {
      resizeCanvas();
    }

    loadCalibrationLine();
    refreshStats();
    setInterval(refreshStats, 5000);
  </script>
{% endblock %}
