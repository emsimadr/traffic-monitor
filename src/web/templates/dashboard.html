{% extends "_layout.html" %}
{% block content %}
  <h1>Dashboard</h1>
  <p class="muted">24h counts and a live feed with the current counting gate.</p>

  <section class="card stats-bar">
    <div class="stat">
      <div class="label" id="label-dir-b">B → A (24h)</div>
      <div class="value" id="stat-dir-b">--</div>
    </div>
    <div class="stat stat-main">
      <div class="label">Total (24h)</div>
      <div class="value big" id="stat-total">--</div>
    </div>
    <div class="stat">
      <div class="label" id="label-dir-a">A → B (24h)</div>
      <div class="value" id="stat-dir-a">--</div>
    </div>
  </section>

  <section class="card live-shell">
    <div class="row" style="justify-content: space-between; align-items: center;">
      <div class="label">Live feed (Gate lines)</div>
      <div class="muted" id="live-updated">—</div>
    </div>
    <div class="live-wrap">
      <img src="/api/camera/live.mjpg" id="live-img" alt="Live stream">
      <canvas id="live-overlay"></canvas>
    </div>
    <div class="muted" style="margin-top:8px;">Gate A and Gate B lines pulled from counting config.</div>
    <div class="muted" id="dash-error"></div>
  </section>

  <script>
    // Direction labels (loaded from config)
    let dirLabels = {
      a_to_b: 'A → B',
      b_to_a: 'B → A',
    };

    const liveImg = document.getElementById('live-img');
    const overlay = document.getElementById('live-overlay');
    const ctx = overlay.getContext('2d');
    let lineA = null;
    let lineB = null;

    function resizeCanvas() {
      const rect = liveImg.getBoundingClientRect();
      overlay.width = Math.max(1, Math.floor(rect.width));
      overlay.height = Math.max(1, Math.floor(rect.height));
      drawLines();
    }

    function drawLines() {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      const toPx = (p) => ({ x: p[0] * overlay.width, y: p[1] * overlay.height });
      const draw = (pts, color) => {
        if (!pts || pts.length !== 2) return;
        const a = toPx(pts[0]);
        const b = toPx(pts[1]);
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
      };
      draw(lineA, 'rgba(0, 201, 255, 0.9)');
      draw(lineB, 'rgba(255, 99, 71, 0.9)');
    }

    function setDefaultLines() {
      lineA = [
        [0.0, 0.5],
        [1.0, 0.5],
      ];
      lineB = [
        [0.0, 0.6],
        [1.0, 0.6],
      ];
      drawLines();
    }

    async function loadConfig() {
      try {
        const res = await fetch('/api/calibration');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const c = data?.counting || {};
        
        // Load gate lines
        const la = c.line_a;
        const lb = c.line_b;
        lineA = Array.isArray(la) && la.length === 2 ? la : null;
        lineB = Array.isArray(lb) && lb.length === 2 ? lb : null;
        if (!lineA || !lineB) setDefaultLines(); else drawLines();
        
        // Load direction labels
        const labels = c.direction_labels || {};
        if (labels.a_to_b) dirLabels.a_to_b = labels.a_to_b;
        if (labels.b_to_a) dirLabels.b_to_a = labels.b_to_a;
        
        // Update UI labels
        document.getElementById('label-dir-a').textContent = `${dirLabels.a_to_b} (24h)`;
        document.getElementById('label-dir-b').textContent = `${dirLabels.b_to_a} (24h)`;
      } catch (e) {
        document.getElementById('dash-error').textContent = 'Config unavailable';
        setDefaultLines();
      }
    }

    async function refreshStats() {
      const errEl = document.getElementById('dash-error');
      errEl.textContent = '';
      try {
        const res = await fetch('/api/stats/summary');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const dir = data.last_24h_by_direction || {};
        
        // Find counts by direction label
        const countA = dir[dirLabels.a_to_b] ?? dir['A_TO_B'] ?? 0;
        const countB = dir[dirLabels.b_to_a] ?? dir['B_TO_A'] ?? 0;
        const total = Number.isFinite(data.last_24h) ? data.last_24h : (countA + countB);

        document.getElementById('stat-dir-a').textContent = countA;
        document.getElementById('stat-dir-b').textContent = countB;
        document.getElementById('stat-total').textContent = total;
        document.getElementById('live-updated').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        errEl.textContent = 'Stats unavailable';
      }
    }

    liveImg.addEventListener('load', resizeCanvas);
    window.addEventListener('resize', resizeCanvas);
    if (liveImg.complete) {
      resizeCanvas();
    }

    loadConfig();
    refreshStats();
    setInterval(refreshStats, 5000);
  </script>
{% endblock %}
